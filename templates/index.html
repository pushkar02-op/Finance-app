<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Display</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      .profit {
        background-color: #d4edda;
      }
      .loss {
        background-color: #f8d7da;
      }
      .child-table-row {
        background-color: #e9ecef;
      }
      .table {
        margin-bottom: 0rem !important;
      }
      .child-table-row th,
      .child-table-row tbody tr td {
        padding: 0.3rem !important;
        font-size: 0.85rem;
        line-height: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mt-5">Profit and Loss</h1>
      <table class="table mt-3">
        <thead>
          <tr>
            <th>Date</th>
            <th>Total Spent</th>
            <th>Total Received</th>
            <th>Daily Profit/Loss</th>
          </tr>
        </thead>
        <tbody id="data-tbody"></tbody>
      </table>
      <ul id="pagination" class="pagination"></ul>
    </div>
    <script>
      let data = [];
      let currentPage = 1;
      const rowsPerPage = 10;

      document.addEventListener("DOMContentLoaded", () => {
        fetchData();
      });

      function fetchData() {
        fetch("/data?_=" + new Date().getTime())
          .then((response) => response.json())
          .then((jsonData) => {
            data = jsonData;
            renderTable(data, currentPage, rowsPerPage);
            setupPagination(data, rowsPerPage);
          });
      }

      function renderTable(data, page, rowsPerPage) {
        const tbody = document.getElementById("data-tbody");
        tbody.innerHTML = "";
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = data.slice(start, end);

        pageData.forEach((row) => {
          const rowClass = row.daily_profit_loss >= 0 ? "profit" : "loss";
          const tr = document.createElement("tr");
          tr.classList.add(rowClass);
          tr.dataset.date = row.date;
          tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.total_spent}</td>
                    <td>${row.total_received}</td>
                    <td>${row.daily_profit_loss}</td>
                `;
          tr.addEventListener("click", () => toggleRowDetails(tr, row.items));
          tbody.appendChild(tr);
        });
      }

      function setupPagination(data, rowsPerPage) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        const pageCount = Math.ceil(data.length / rowsPerPage);

        for (let i = 1; i <= pageCount; i++) {
          const li = document.createElement("li");
          li.classList.add("page-item");
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", () => {
            currentPage = i;
            renderTable(data, currentPage, rowsPerPage);
          });
          pagination.appendChild(li);
        }
      }

      function toggleRowDetails(tr, items) {
        const existingChildTable = tr.nextElementSibling;
        if (
          existingChildTable &&
          existingChildTable.classList.contains("child-table-row")
        ) {
          existingChildTable.remove();
          return;
        }

        const childTable = document.createElement("tr");
        childTable.classList.add("child-table-row");
        childTable.innerHTML = `
                <td colspan="4">
                    <table class="table child-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Total Spent</th>
                                <th>Total Received</th>
                                <th>Daily Profit/Loss</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items
                              .map((item) => {
                                const itemClass =
                                  item.daily_profit_loss >= 0
                                    ? "profit"
                                    : "loss";
                                return `
                                    <tr class="${itemClass}">
                                        <td>${item.item}</td>
                                        <td>${item.total_spent}</td>
                                        <td>${item.total_received}</td>
                                        <td>${item.daily_profit_loss}</td>
                                    </tr>
                                `;
                              })
                              .join("")}
                        </tbody>
                    </table>
                </td>
            `;
        tr.insertAdjacentElement("afterend", childTable);
      }
    </script>
  </body>
</html>
