from flask import Flask, render_template, request, jsonify
from openpyxl import load_workbook
from openpyxl import Workbook
from datetime import datetime
import webbrowser


app = Flask(__name__)

@app.route("/")
def home():
    return render_template("form.html")


@app.route("/submit", methods=["POST"])

def submit():
    date = request.form["date"]
    item = request.form["item"]
    qty = request.form["qty"]
    price = request.form["price"]
    total = request.form["total"]

    # Parse date string to datetime object
    date_obj = datetime.strptime(date, "%Y-%m-%d").date()

    try:
        wb = load_workbook("data.xlsx")
        ws = wb.active
    except FileNotFoundError:
        wb = Workbook()
        ws = wb.active
        ws.append(["Date", "Item", "Quantity", "Price", "Total"])

    # Check if data with the same date already exists
    for row in ws.iter_rows(min_row=2, max_row=ws.max_row, min_col=1, max_col=2):
        if row[0].value == date and row[1].value == item :
            # Update existing row with the same date
            row_index = row[0].row
            ws.cell(row=row_index, column=2, value=item)
            ws.cell(row=row_index, column=3, value=qty)
            ws.cell(row=row_index, column=4, value=price)
            ws.cell(row=row_index, column=5, value=total)
            break
    else:
        # If data with the same date does not exist, append a new row
        next_row = ws.max_row + 1
        ws.cell(row=next_row, column=1, value=date)
        ws.cell(row=next_row, column=2, value=item)
        ws.cell(row=next_row, column=3, value=qty)
        ws.cell(row=next_row, column=4, value=price)
        ws.cell(row=next_row, column=5, value=total)
    
    wb.save("data.xlsx")

    return "Data submitted successfully!"

@app.route("/get_data")
def get_data():
    req_date = request.args.get("reqdate")
    
    # Load workbook
    try:
        wb = load_workbook("data.xlsx")
        ws = wb.active

    except FileNotFoundError:
        return jsonify([])  # Return empty list if file not found

  

    data = []
    for row in ws.iter_rows(min_row=2, max_row=ws.max_row, values_only=True):
        if row[0] == req_date:
            # Convert row data to dictionary
            row_data = {
                "date": row[0],
                "item": row[1],
                "qty": row[2],
                "price": row[3],
                "total": row[4]
            }
            data.append(row_data)
    return jsonify(data)
    
# Open the browser to the specified URL
# webbrowser.open("http://127.0.0.1:5000/")

if __name__ == "__main__":
    # Start the Flask application
    app.run(debug=True)

    